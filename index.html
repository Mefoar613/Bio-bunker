<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bio-Bunker 2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            touch-action: none; 
            user-select: none;
        }

        /* Экраны */
        .screen {
            display: none;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0;
            background-size: cover;
            background-position: center;
            z-index: 1;
        }
        .active { display: flex; }

        /* Фон меню (заглушка - город) */
        #screen-menu {
            background-image: url('https://i.imgur.com/8w6g4rE.png'); /* Твоя картинка */
            background-color: #000;
        }
        
        /* Затемнение фона для текста */
        .overlay {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #0f0;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        h1 { color: #0f0; text-shadow: 0 0 10px #0f0; margin: 0 0 20px 0; font-size: 28px; }

        .btn {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 15px 40px;
            font-size: 20px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 10px #0f0;
            transition: 0.2s;
            margin-top: 10px;
        }
        .btn:active { background: #0f0; color: #000; transform: scale(0.95); }

        /* ИГРОВОЙ ИНТЕРФЕЙС */
        #hud {
            position: absolute;
            top: 10px; left: 10px;
            color: #0f0;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
            pointer-events: none;
            z-index: 10;
        }
        
        canvas { display: block; background: #2b2b2b; }

    </style>
</head>
<body>

    <div id="screen-menu" class="screen active">
        <div class="overlay">
            <h1>☢ BIO-BUNKER ☢</h1>
            <p>Версия 2.0: Звук и Графика</p>
            <button class="btn" onclick="startGame()">НАЧАТЬ ВЫЛАЗКУ</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="hud">☢ БИО-РЕСУРС: <span id="score">0</span></div>
        <canvas id="gameCanvas"></canvas>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- ЗВУКИ (Закодированы в base64, чтобы работать без файлов) ---
        // Звук подбора (короткий пик)
        const soundCollect = new Audio("data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"); 
        // (Это пустой звук-заглушка для примера, реальный звук сработает через генератор частот ниже)

        // Аудио контекст для синтеза звуков (чтобы не грузить файлы)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'square'; // 8-битный звук
            osc.frequency.setValueAtTime(440, audioCtx.currentTime); // Нота Ля
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1); // Вверх
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function playBoom() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);

            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        // --- ГРАФИКА (СПРАЙТЫ) ---
        const imgHero = new Image(); imgHero.src = 'https://img.icons8.com/color/96/hazmat-suit.png'; // Мужик в химзащите
        const imgBarrel = new Image(); imgBarrel.src = 'https://img.icons8.com/color/96/oil-barrel.png'; // Бочка
        const imgRad = new Image(); imgRad.src = 'https://img.icons8.com/color/96/radioactive.png'; // Знак радиации

        // --- ИГРОВАЯ ЛОГИКА ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameLoopId;
        
        let hero = { x: 0, y: 0, vx: 0, vy: 0, angle: 0 };
        let items = [];
        let enemies = [];
        let score = 0;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            hero.x = canvas.width / 2;
            hero.y = canvas.height / 2;
        }
        window.addEventListener('resize', resize);

        function startGame() {
            document.getElementById('screen-menu').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            resize();
            
            // Инициализация звука по клику
            audioCtx.resume();

            score = 0;
            items = [];
            enemies = [];
            
            // Спавн предметов
            for(let i=0; i<10; i++) spawnItem();
            for(let i=0; i<3; i++) spawnEnemy();
            
            update();
        }

        function spawnItem() {
            items.push({
                x: Math.random() * (canvas.width - 40) + 20,
                y: Math.random() * (canvas.height - 40) + 20
            });
        }
        
        function spawnEnemy() {
            enemies.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 3,
                vy: (Math.random() - 0.5) * 3
            });
        }

        // УПРАВЛЕНИЕ (ДЖОЙСТИК)
        let touchStart = null;
        canvas.addEventListener('touchstart', e => { touchStart = {x: e.touches[0].clientX, y: e.touches[0].clientY}; });
        canvas.addEventListener('touchmove', e => {
            if(!touchStart) return;
            let dx = e.touches[0].clientX - touchStart.x;
            let dy = e.touches[0].clientY - touchStart.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            if (dist > 0) {
                let speed = 4;
                hero.vx = (dx/dist) * speed;
                hero.vy = (dy/dist) * speed;
                // Поворот спрайта (опционально, пока просто бегает)
            }
        });
        canvas.addEventListener('touchend', () => { hero.vx = 0; hero.vy = 0; touchStart = null; });

        function update() {
            ctx.fillStyle = '#222'; // Цвет земли
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Сетка земли (для ощущения движения)
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for(let x=0; x<canvas.width; x+=50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
            for(let y=0; y<canvas.height; y+=50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }

            // ГЕРОЙ
            hero.x += hero.vx; hero.y += hero.vy;
            // Ограничение экраном
            hero.x = Math.max(20, Math.min(canvas.width-20, hero.x));
            hero.y = Math.max(20, Math.min(canvas.height-20, hero.y));
            
            // Рисуем Героя (Картинка)
            ctx.drawImage(imgHero, hero.x - 24, hero.y - 24, 48, 48);

            // ПРЕДМЕТЫ (БОЧКИ)
            for (let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                ctx.drawImage(imgBarrel, it.x - 20, it.y - 20, 40, 40);
                
                // Сбор
                if (Math.hypot(hero.x - it.x, hero.y - it.y) < 40) {
                    items.splice(i, 1);
                    score += 10;
                    document.getElementById('score').innerText = score;
                    playBeep(); // ЗВУК!
                    tg.HapticFeedback.impactOccurred('light'); // Вибрация
                    spawnItem(); // Спавним новую
                }
            }

            // ВРАГИ (РАДИАЦИЯ)
            for (let e of enemies) {
                e.x += e.vx; e.y += e.vy;
                if(e.x<0 || e.x>canvas.width) e.vx *= -1;
                if(e.y<0 || e.y>canvas.height) e.vy *= -1;
                
                ctx.drawImage(imgRad, e.x - 25, e.y - 25, 50, 50);

                if (Math.hypot(hero.x - e.x, hero.y - e.y) < 40) {
                    playBoom(); // ЗВУК ВЗРЫВА
                    tg.HapticFeedback.notificationOccurred('error');
                    alert("ВЫ ПОПАЛИ В ЗОНУ РАДИАЦИИ!");
                    location.reload();
                    return;
                }
            }

            requestAnimationFrame(update);
        }

    </script>
</body>
</html>
